<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - Hotel Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    {% csrf_token %}
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">Hotel Booking</a>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-body">
                        <h3 class="card-title mb-4">Complete Your Payment</h3>
                        <div class="alert alert-info">
                            <h6>Payment Details</h6>
                            <p class="mb-0">Order ID: <strong>{{ payment_details.order_id|default:"N/A" }}</strong></p>
                            <p class="mb-0">Total Amount: <strong>â‚¹<span id="display-amount">{{ payment_details.amount_rupees|default:"0" }}</span></strong></p>
                        <div id="payment-form">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3">Initializing payment gateway...</p>
                            </div>
                        </div>

                        <div class="mt-4">
                            <a href="/" class="btn btn-secondary">Cancel Payment</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-primary text-white text-center py-3">
        <div class="container">
            &copy; 2024 Hotel Booking. All rights reserved.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize Razorpay payment
        document.addEventListener('DOMContentLoaded', function() {
            // Convert amount from paise to rupees for display
            const amountInPaise = parseInt("{{ payment_details.amount|default:0 }}");
            const amountInRupees = (amountInPaise / 100).toFixed(2);
            document.getElementById('display-amount').textContent = amountInRupees;
            
            // Payment configuration
            const paymentConfig = {
                key: "{{ razorpay_key_id|default:'' }}",
                orderId: "{{ payment_details.razorpay_order_id|default:'' }}",
                orderAmount: parseInt("{{ payment_details.amount|default:0 }}"),
                orderCurrency: "{{ payment_details.currency|default:'INR' }}",
                guestName: "{{ payment_details.guest_name|default:'' }}",
                guestEmail: "{{ payment_details.guest_email|default:'' }}",
                guestPhone: "{{ payment_details.guest_phone|default:'' }}",
                orderIdDisplay: "{{ payment_details.order_id|default:'' }}"
            };

            // Check if required configuration is available
            if (!paymentConfig.key || !paymentConfig.orderId) {
                console.error("Payment configuration incomplete");
                alert("Payment configuration error. Please contact support.");
                return;
            }

            const options = {
                key: paymentConfig.key,
                amount: paymentConfig.orderAmount * 100, // Convert to paise
                currency: paymentConfig.orderCurrency,
                name: "Hotel Booking",
                description: "Room Booking Payment",
                order_id: paymentConfig.orderId,
                handler: function(response) {
                    // Handle successful payment
                    console.log("Payment successful:", response);
                    window.location.href = "{% url 'payment_success' %}";
                },
                prefill: {
                    name: paymentConfig.guestName,
                    email: paymentConfig.guestEmail,
                    contact: paymentConfig.guestPhone
                },
                notes: {
                    "Order ID": paymentConfig.orderIdDisplay
                },
                theme: {
                    color: "#007bff"
                },
                modal: {
                    ondismiss: function() {
                        console.log("Payment modal closed");
                    }
                }
            };

            try {
                const rzp = new Razorpay(options);
                
                // Auto-open payment modal
                rzp.open();
                
                // Handle payment failure
                rzp.on('payment.failed', function(response) {
                    console.log("Payment failed:", response.error);
                    window.location.href = "{% url 'payment_failure' %}";
                });
            } catch (error) {
                console.error("Error initializing payment:", error);
                alert("Error initializing payment. Please try again.");
            }
        });
    </script>
</body>
</html>